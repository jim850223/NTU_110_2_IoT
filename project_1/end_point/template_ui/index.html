<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>HeroBiz Bootstrap Template - Home 4</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Poppins:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,600;0,700;1,300;1,400;1,600;1,700&display=swap"
    rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Variables CSS Files. Uncomment your preferred color scheme -->
  <link href="assets/css/variables.css" rel="stylesheet">
  <!-- <link href="assets/css/variables-blue.css" rel="stylesheet"> -->
  <!-- <link href="assets/css/variables-green.css" rel="stylesheet"> -->
  <!-- <link href="assets/css/variables-orange.css" rel="stylesheet"> -->
  <!-- <link href="assets/css/variables-purple.css" rel="stylesheet"> -->
  <!-- <link href="assets/css/variables-red.css" rel="stylesheet"> -->
  <!-- <link href="assets/css/variables-pink.css" rel="stylesheet"> -->

  <!-- Template Main CSS File -->
  <link href="assets/css/main.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: HeroBiz - v2.1.0
  * Template URL: https://bootstrapmade.com/herobiz-bootstrap-business-template/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>
  <main id="main">
    <!-- ======= Features Section ======= -->
    <section id="features" class="features">
      <div class="container" data-aos="fade-up">

        <ul class="nav nav-tabs row gy-4 d-flex">


          <li class="nav-item col-6 col-md-4 col-lg-2">

            <!-- 這列是決定能否動的重點 -->
            <a class="nav-link active show" data-bs-toggle="tab" onclick="ring_bell_button()" ; data-bs-target="#tab-1">
              <i class="bi bi-bell color-red"></i>
              <h4>按鈴</h4>
            </a>
          </li><!-- End Tab 1 Nav -->


          <li class="nav-item col-6 col-md-4 col-lg-2">
            <a class="nav-link" data-bs-toggle="tab" onclick="trigger();" data-bs-target="#tab-3">
              <i class="bi bi-box-seam color-indigo"></i>
              <h4>包裹簽收</h4>
            </a>
          </li><!-- End Tab 3 Nav -->


          <div class="tab-content">
            <div class="tab-pane active show" id="tab-1">
              <!--   <div class="tab-pane fade show active" id="tab-1"></div> -->
              <div class="p-5 mb-4 bg-light rounded-3">
                <div class="container-fluid py-5">
                  <h1 class="display-5 fw-bold" id="bell_message">您好，請問能怎麼協助您</h1>
                </div>
              </div>
            </div>

            <div class="tab-pane fade show" id="tab-3">
              <div class="p-5 mb-4 bg-light rounded-3">
                <div class="container-fluid py-5">
                  <h1 class="display-5 fw-bold">請掃描QR CODE</h1>
                </div>
              </div>
            </div>
          </div>

      </div>
    </section><!-- End Features Section -->
  </main><!-- End #main -->

  <a href="#" class="scroll-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <div id="preloader"></div>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>

  <script>

    async function prototype() {
      const delay = (s) => {
        return new Promise(function (resolve) {  // 回傳一個 promise
          setTimeout(resolve, s);               // 等待多少秒之後 resolve()
        });
      };

      await delay(1000);

      await delay(2000);
    }

    var state = 0;
    //0 means there is no job to do, 1 is opposite to 0

    var command_to_do;
    var command_parameters;
    var message;

    function call_Rpi_ring_bell() {
      const uri = `http://127.0.0.1:5000/bell`;
      fetch(uri, { method: 'GET' })
        .then(res => {
          return res.text();   // 使用 text() 可以得到純文字 String
        }).then(result => {
          console.log(result);
        });
    }



    function opendoor() {
      console.log('ask for door-opening');
      const uri = `http://127.0.0.1:5000/open_door`;
      fetch(uri, { method: 'GET' })
        .then(res => {
          return res.text();   // 使用 text() 可以得到純文字 String
        }).then(result => {
          console.log(result);
        });
    }

    //leave for Rpi to do
    function leave_message() {
    }


    async function ring_bell_button() {
      const delay = (s) => {
        return new Promise(function (resolve) {  // 回傳一個 promise
          setTimeout(resolve, s);               // 等待多少秒之後 resolve()
        });
      };
      call_Rpi_ring_bell();
      document.getElementById("bell_message").innerHTML = '響鈴中，請稍等';
      await delay(5000);
      if (command_to_do == 'openDoor') {
        opendoor();
        document.getElementById("bell_message").innerHTML = '已為您將門開啟';
        await delay(3000);
        state = 0;
        document.getElementById("bell_message").innerHTML = '您好，請問能怎麼協助您';
      }
      else if (command_to_do == 'setMessage') {
        document.getElementById("bell_message").innerHTML = message;
        await delay(5000);
        state = 0;
        document.getElementById("bell_message").innerHTML = '您好，請問能怎麼協助您';
      }
      else {
        document.getElementById("bell_message").innerHTML = '主人未回應，請稍候再試';
        await delay(3000);
        state = 0;
        document.getElementById("bell_message").innerHTML = '您好，請問能怎麼協助您';
      }
      message = 0;
      command_to_do = 0;
      //參數歸零
    }

    function comment_button() {
      status = 2;
    }

    function sign_button() {
      status = 3;
    }


    function getDeviceCommand() {
      /* get the status from the server */
      const uri = `http://127.0.0.1:3000/api/device/1/commands`;
      //實際跑時的server

      //const uri = `http://127.0.0.1:5000/device/1/commands`;
      //測試用api，用以返回開門狀態

      fetch(uri, { method: 'GET' })
        .then(res => {
          return res.json();   // 使用 text() 可以得到純文字 String, json()可以獲得json
        }).then(result => {

          console.log(!result.data[0]);
          //沒有action時，!result.data[0]為true

          if (state == 0 && result.data[0]) {
            state = 1;

            command_to_do = result.data[0].action;
            console.log(command_to_do);

            message = result.data[0].parameters.message;
            console.log(message);
          }
        });
    }

    setInterval(getDeviceCommand, 1000)

  </script>


</body>

</html>